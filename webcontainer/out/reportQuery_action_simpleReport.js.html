<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: reportQuery/action/simpleReport.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: reportQuery/action/simpleReport.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
// 对于simplereport 组件的一些方法

import deepCopy from '../../../utils/deep-copy';

import {toast} from 'nc-lightapp-front';

const defaultSearchItem = [{
    attrcode: 'report-empty',
    visible: true,
    label: '',
    required: false,
    checkStrictly: false,
    col: "3",
    colnum: "1",
    color: null,
    containlower: false,
    dataPowerOperationCode: null,
    datatype: "0",
    disabled: false,
    editAfterFlag: false,
    fieldDisplayed: null,
    fieldValued: null,
    formattype: null,
    functions: null,
    hyperlinkflag: false,
    initialvalue: null,
    isDataPowerEnable: null,
    isMultiSelectedEnabled: null,
    isResLabel: false,
    isShowUnit: false,
    isTreelazyLoad: null,
    isdrag: false,
    isfixedcondition: false,
    isnextrow: false,
    isnotmeta: false,
    isrevise: null,
    itemtype: null,
    languageMeta: null,
    leftspace: "0",
    max: null,
    maxlength: "0",
    metadataProperty: null,
    min: null,
    options: null,
    pid: null,
    pk_defdoclist: null,
    position: "0",
    queryOperateType: null,
    ratio: null,
    refName_db: null,
    refcode: null,
    rightspace: "0",
    rows: "0",
    scale: "0",
    unit: null,
    usefunc: false,
    visibleposition: "0"
}];

export default class SimpleReport {
    constructor(comp) {
        this.comp = comp;
        Object.assign(this, comp.props);
    }

    // 修改meta
    disposeSearch = (meta, props) => {
        const {
            reportSearchMap, 
            currentTreeData,
            ifHideSearchModal,
            showCustomSearchBody
        } = this.comp.props.reportQuery;

        // 如果没有设定隐藏查询弹窗
        if(!ifHideSearchModal) {
            // 找到查询弹窗对应的查询模版
            let searchTmp = meta[reportSearchMap[currentTreeData]];

            searchTmp = this.processSpecialItem(searchTmp, currentTreeData);

            // 有配置search模版, 让light_report 模版的items改成配置的items
            if(searchTmp) {
                // 这部防止如果查询模版是空的，添加个默认的，防止他不显示
                if(searchTmp.items.length &lt;= 0) {
                    searchTmp.items = deepCopy(defaultSearchItem)
                }
                // 将light_report换成对应的查询模版
                meta['light_report'] = searchTmp;
            }
            // 如果没有配置search模版，用默认的light_report模版, 并且如果默认的light_reportitems为空，则给个默认的
            else {
                if(meta['light_report'].items.length &lt;= 0) {
                    meta['light_report'].items = deepCopy(defaultSearchItem);
                }
            }

            // 清空一下上一次填写的值
            this.dispatch({
                type: 'reportQuery/update',
                payload: {
                    customFormValue: {}
                }
            });
        }

        return meta;
    }

    // 对于特殊的查询条件进行特殊处理
    processSpecialItem = (template) => {

        // 人员类别汇总表的人员类别查询参照多选
        // 部门汇总表的部门参照多选
        if(!template) {
            return template;
        }
        if(
            template.code === 'psnclsum' || 
            template.code === 'deptsum' || 
            template.code === 'deptaccount'
        ) {
            template.items.map((item) => {
                if(item.attrcode === 'pk_psnjob.pk_psncl') {
                    item.isMultiSelectedEnabled = true;
                }
                if(item.attrcode === 'pk_psnjob.pk_dept.name') {
                    item.isMultiSelectedEnabled = true;
                }
                if(item.attrcode === 'pk_psnjob.pk_dept') {
                    item.isMultiSelectedEnabled = true;
                }
            });
        }

        return template;
    }

    // 发起搜索钱扩展搜索条件
    expandSearchVal = (items, props, type, queryInfo) => {
        const {
            currentQueryForm, 
            queryRightData, 
            language,
            orgValue,
            ifHideSearchModal,
            hasShowQueryCondition,
            currentTreeData,
            employeeV,
            showCustomSearchBody,
            customFormValue,
            customFormData
        } = this.comp.props.reportQuery;

        // 如果不弹出查询弹窗，默认直接返回条件
        if(ifHideSearchModal) {
            return items;
        }

        // 如果items不是一个数组
        if(!Array.isArray(items)) {
            items = {
                logic: 'and',
                conditions: []
            }
        }

        // 如果是组织节点，则需要将组织拼到条件里
        if(orgValue) {
            items.conditions.unshift({
                field: 'pk_org',
                value: {
                    firstvalue: orgValue.refpk
                }
            });
        }

        // 如果展示的是自定义的查询内容，进行特殊处理
        if(showCustomSearchBody) {
            let isEmptyItem = [];
            customFormData.map((item) => {
                if(item.required &amp;&amp; customFormValue[item.code] === undefined) {
                    isEmptyItem.push(item.name);
                }
            })
            if(isEmptyItem.length > 0) {
                setTimeout(() => {
                    props.search.openAdvSearch('light_report', true);
                }, 0);
                toast({
                    color: 'danger',
                    content: `${isEmptyItem.join(', ')}${language['i6013-000733']}`, // xxx为必填项
                });
                return false
            }
        }
        else {
            let formData = null;
            // 如果有查询表单
            if(currentQueryForm) {
                formData = this.form.getAllFormValue(currentQueryForm);
            }
            // 穿梭狂数据写进条件里
            let rightList = deepCopy(queryRightData);
            rightList.map((item) => {
                // display是为了适应穿梭狂加的字段
                delete item['display'];
            });
            if(rightList.length &lt;= 0) {
                toast({
                    color: 'warning',
                    content: language['i6013-000790'], // 已选薪资项目不能为空！
                });
                setTimeout(() => {
                    props.search.openAdvSearch('light_report', true);
                }, 0);
                return false;
            }
            // 把穿梭狂右侧值拼到条件里
            items.conditions.unshift({
                field: 'items',
                value: {
                    firstvalue: JSON.stringify(rightList)
                }
            });
            // 如果是员工收入台账报表，则需要给报表的员工item赋值，以绕过必填检测
            if(currentTreeData === '1001Z71000000000A3GT') {
                this.form.setFormItemsValue(currentQueryForm, {
                    waEmployeePk: {
                        value: employeeV.value
                    }
                });
            }
            // 检测是否填写或者打开了form表单
            if(hasShowQueryCondition === false || !this.checkFormData(formData.rows[0].values)) {
                toast({
                    color: 'warning',
                    content: language['i6013-000725'], // 请先填写查询条件2
                });
                setTimeout(() => {
                    props.search.openAdvSearch('light_report', true);
                }, 0);
                return false;
            }
            // 如果formData有数据，并且没有通过检测
            else if(formData &amp;&amp; !this.form.isCheckNow(currentQueryForm)) {
                setTimeout(() => {
                    props.search.openAdvSearch('light_report', true);
                }, 0);
                return false;
            }
            // 如果拿到了form数据，就进行拼接查询条件
            if(formData) {
                Object.keys(formData.rows[0].values).map((key) => {
                    // 员工台帐报表比较特殊，form理由查询弹窗, 所以特殊处理
                    if(currentTreeData === '1001Z71000000000A3GT' &amp;&amp; key === 'waEmployeePk') {
                        items.conditions.unshift({
                            field: 'waEmployeePk',
                            value: {
                                firstvalue: employeeV.value
                            }
                        });
                    }
                    else {
                        // 正常的把form表单值加进条件里
                        items.conditions.unshift({
                            field: key,
                            value: {
                                firstvalue: formData.rows[0].values[key].value,
                                secondvalue: null
                            }
                        });
                    }
                });
            }
        }
        return items;
    }

    // 自定义查询数据
    isBusiRender = () => {

        const {ifHideSearchModal} = this.comp.props.reportQuery;
        let searchData = {
            logic: '',
            conditions: []
        };

        return this.dispatch({
            type: 'reportQuery/getReportData',
            payload: {}
        })
            .then((res) => {
                this.dispatch({
                    type: 'reportQuery/update',
                    payload: {
                        ifInit: false
                    }
                });
                return {
                    data: res
                }
            });
    }

    // 检测form值
    checkFormData = (formData) => {
        let result = false;

        Object.keys(formData).map((key) => {
            if(formData[key].value !== null) {
                result = true;
            }
        });

        return result;
    }

    // 处理自定义弹窗内容的参数
    processUserDefObj = () => {
        let {customFormValue} = this.comp.props.reportQuery;

        return customFormValue;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#sortBtns">sortBtns</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 16:34:25 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
