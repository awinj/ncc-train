<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: reportQuery/action/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: reportQuery/action/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>

import mockData from '../store/mock';
import deepCopy from '../../../utils/deep-copy';

export default class Actions {
    constructor(comp) {
        this.comp = comp;
        Object.assign(this, comp.props);
    }

    // 初始化页面
    init = () => {
        this.getLanguage();
        this.getTemplate()
            .then(() => {
                this.initPage();
            });
    }
    // 左树选中了一棵树
    selectTree = (refpk) => {
        const {
            reportTemplateMap = {},
            folderTreeList,
            reportSearchMap = {}
        } = this.comp.props.reportQuery;

        // 重新选中的时候一些值要重新赋值
        this.dispatch({
            type: 'reportQuery/update',
            payload: {
                currentTreeData: '',
                ifInit: true,
                ifHideSearchModal: false,
                hasShowQueryCondition: false,
                showCustomSearchBody: false,
                showAdvSearchPlanBtn: true,
                customFormData: [],
                customFormValue: {}
            }
        });

        // 第一次请求回来的是文件夹而不是报表
        if(folderTreeList.includes(refpk[0]) || refpk[0] === 'root') {
            return false;
        }
        // 如果有对应的查询form或者查询模版，则都要显示查询弹窗
        else if(reportTemplateMap[refpk[0]] || reportSearchMap[refpk[0]]) {
            this.dispatch({
                type: 'reportQuery/update',
                payload: {
                    currentTreeData: refpk[0],
                    currentQueryForm: reportTemplateMap[refpk[0]]
                }
            });
        }
        else {
            // 如果没有对应的查询模版或者form，就去查询是否有自定义的表格弹窗
            this.dispatch({
                type: 'reportQuery/getCustomModalData',
                payload: {
                    pk_report: refpk[0]
                }
            })
                .then((res) => {
                    
                    if(res.data) {
                        this.processCustomSearchData(res.data)
                            .then((data) => {
                                this.dispatch({
                                    type: 'reportQuery/update',
                                    payload: {
                                        currentTreeData: refpk[0],
                                        currentQueryForm: '',
                                        showCustomSearchBody: true,
                                        showAdvSearchPlanBtn: false,
                                        customFormData: data
                                    }
                                });
                            });
                    }
                    else {
                        this.dispatch({
                            type: 'reportQuery/update',
                            payload: {
                                currentTreeData: refpk[0],
                                currentQueryForm: '',
                                ifHideSearchModal: true
                            }
                        });
                    }
                })
                .catch((e) => {
                    this.dispatch({
                        type: 'reportQuery/update',
                        payload: {
                            currentTreeData: refpk[0],
                            currentQueryForm: '',
                            ifHideSearchModal: true
                        }
                    });
                });
        }
    }
    // 左树拉取子树数据
    loadChildTree = (refpk, treeNode) => {
        if(refpk === 'root') {
            return;
        }
        this.dispatch({
            type: 'reportQuery/loadSubTreeData',
            payload: {
                pk_folder: refpk
            }
        })
            .then((res) => {
                this.asyncTree.setTreeData('reportTree', res.data, treeNode);
            });
    }
    // 初始化页面数据
    initPage = () => {
        return new Promise((resolve, reject) => {
            this.getTreeData();
        });
    }
    // 获取左树数据
    getTreeData = () => {
        this.dispatch({
            type: 'reportQuery/getTreeData'
        })
            .then((res) => {
                let treeData = deepCopy(mockData.rootTreeData);
                treeData[0].children = res.data;
                this.asyncTree.setTreeData('reportTree', treeData);

                this.dispatch({
                    type: 'reportQuery/update',
                    payload: {
                        folderTreeList: res.data.map(item => item.id)
                    }
                });
            });
    }
    // 获取模版
    getTemplate = () => {
        return new Promise((resolve, reject) => {
            this.createUIDom(this.appConfig, (res) => {
                Object.keys(res.template).map((key) => {
                    if(res.template[key] &amp;&amp; res.template[key].moduletype === 'form') {
                        res.template[key].items.map((item) => {
                            if(item.itemtype === 'refer' &amp;&amp; !item.queryCondition) {
                                item['queryCondition'] = {};
                            }
                        })
                    }
                });
                res.template = this.processSpecial(res.template);
                console.log(res);
                this.dispatch({
                    type: 'reportQuery/update',
                    payload: {
                        context: res.context
                    }
                });
                this.meta.setMeta(res.template);
                this.button.setButtons(res.button);
                resolve();
            });
        });
        
    }

    // 处理特殊模版特殊数据
    processSpecial = (template) => {

        Object.keys(template).map((key) => {
            // 人员类别汇总的人员类别多选
            // 部门汇总表的汇总部门参照多选
            if(
                key === 'WaSumByPsnclQueryConditionPanel' ||
                key === 'WaSumByDeptQueryConditionPanel' || 
                key === 'DeptWaAccountQueryConditionPanel'
            ) {
                template[key].items.map((item) => {
                    if(item.attrcode === 'sumPsncl') {
                        item['isMultiSelectedEnabled'] = true;
                    }
                    if(item.attrcode === 'sumDept') {
                        item['isMultiSelectedEnabled'] = true;
                    }
                });
            }
        });

        return template;
    }

    // 获取多语言
    getLanguage = () => {
        this.MultiInit.getMultiLang({
            moduleId: 'i6013',
            domainName: 'hrwa',
            callback: (json, status, init) => {
                this.dispatch({
                    type: 'reportQuery/update',
                    payload: {
                        language: json
                    }
                });
            }
        });
    }

    // 处理自定义查询区域返回来的数据
    processCustomSearchData = (data) => {

        let refCodes = [];
        let referItemIndex = [];
        let itemList = JSON.parse(data);
        
        itemList.map((item, index) => {
            if(/[456]/.test(item.dataType)) {
                refCodes.push(item.refCode);
                referItemIndex.push(index)
            }
            else if(/[23]/.test(item.dataType)) {
                item['options'] = item.refCode.split('@')
            }
        });

        return this.dispatch({
            type: 'reportQuery/getReferRefPath',
            payload: {
                refCode: refCodes.join(',')
            }
        })
            .then((res) => {
                if(Array.isArray(res.data)) {
                    referItemIndex.map((item, index) => {
                        itemList[item].refPath = res.data[index]
                    })
                }

                return itemList
            });
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#sortBtns">sortBtns</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 16:34:25 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
