<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: adjPopRefer/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: adjPopRefer/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {base, ajax, toast, high} from 'nc-lightapp-front';
import React from 'react';


const {Refer} = high
const PopRefer = Refer.PopRefer
const { NCCheckbox } = base
const MultiLangWrapper = Refer.MultiLangWrapper

class AdjPopRefer extends PopRefer{
    constructor(props) {
		super(props);
    }
    renderPopoverBottomExtend = () => {
		let { tableData, selectedKeys, isSearch, searchVal } = this.state
		const { refType, isPartFlag, rootNode } = this.props;
		let _this = this
		//定调资人员参照是否显示兼职
		return refType === 'gridTree' &amp;&amp; isPartFlag &amp;&amp; (
			&lt;NCCheckbox
				onChange={(value) => {
					let parm = {
						pid: selectedKeys[0] === rootNode.refpk ? '' : selectedKeys[0] || '',
						pageInfo: tableData[0].page,
						keyword: isSearch ? searchVal : '',
						queryCondition: {
							isPartJob: value
						}
					}
					_this.loadAndSetTableData(parm, false)
					_this.setState({
						isPartJob : value
					})
				}}
			>
				{_this.props.btnName || ''}
			&lt;/NCCheckbox>
		)
	}
	// 获取请求参数
	__getParam = (param = {}) => {
		let {
			queryCondition,
			pageSize,
			refType,
			isShowUnit,
			isShowDisabledData,
			isHasDisabledData,
			pk_defdoclist,
			dataPowerOperationCode,
			isDataPowerEnable,
			unitProps
		} = this.props,
			{ isShow } = this.state,
			{ keyword = '', pid = '', pageInfo = {}, searchPks } = param;
		pageInfo = {
			pageSize: pageInfo.pageSize || pageSize,
			pageIndex: pageInfo.pageIndex || (refType === 'tree' ? -1 : 0)
		};
		if (pageInfo.pageSize == -1) {
			pageInfo.pageIndex = -1;
		}
		let extraCondition = {};
		unitProps &amp;&amp;
			isShowUnit &amp;&amp;
			(extraCondition[unitProps.key || 'unitPks'] =
				Array.isArray(this.state.unit) &amp;&amp; this.state.unit.length
					? this.state.unit.map(e => e.refpk).join(',')
					: (this.state.unit || {}).refpk);
		isHasDisabledData &amp;&amp; isShowDisabledData &amp;&amp; (extraCondition.isShowDisabledData = this.state.isShowDisabledData);
		!isShow &amp;&amp; keyword &amp;&amp; (extraCondition.searchFlag = true);
		extraCondition.isShowUnit = !!isShowUnit;
		// 模板上会返回下面几个属性
		pk_defdoclist !== undefined &amp;&amp; (extraCondition.pk_defdoclist = pk_defdoclist);
		dataPowerOperationCode !== undefined &amp;&amp; (extraCondition.DataPowerOperationCode = dataPowerOperationCode);
		isDataPowerEnable !== undefined &amp;&amp; (extraCondition.isDataPowerEnable = isDataPowerEnable);

		let final = {
			...param,
			pid, // 对应的树节点
			keyword,
			defineItems: this.getSearchConfigCodes(), // 搜索设置字段
			queryCondition: {
				...(typeof queryCondition === 'function'
					? queryCondition(this.props)
					: typeof queryCondition === 'object' ? queryCondition : {})
			},
			pageInfo,
			...this.getParam(param || {})
		};

		final.queryCondition = { ...extraCondition, ...final.queryCondition, ...param.queryCondition };
		if (Array.isArray(searchPks) &amp;&amp; searchPks.length) {
			final.searchPks = searchPks;
			final.pageInfo.pageSize = searchPks.length;
		}
		return final;
	};
	// 刷新
	refresh = (clearCache = true) => {
		let { pageSize, rootNode, refType, idKey } = this.props,
			{ selectedKeys } = this.state;
		// state数据清空
		let { isPartJob } = this.state
		let _this =this
		let defaultState = {
			tableData: [
				{
					rows: [],
					page: {
						pageIndex: 0,
						pageSize,
						totalPage: 1
					}
				}
			], // 参照的数据
			treeData: [
				rootNode
			] // 左树的值
		};
		// 缓存数据清空
		this.clearCache();
		// 树表时清除左树选中
		if (refType === 'gridTree') {
			selectedKeys = [];
		}
		// 清空搜索框
		let newState = {
			...defaultState,
			selectedKeys,
			searchVal: '',
			treeSearchVal: '',
			isTreeSearch: false,
			isSearch: false,
			expandedKeys: [
				rootNode[idKey]
			],
			isPartJob: isPartJob || false
		};
		clearCache &amp;&amp; (newState.selectedValues = new Map(JSON.parse(JSON.stringify(this._value)))); // 已选恢复到点开时
		this.setState(newState, () => {
			// 查全部数据
			_this.show(true);
		});
	};

		// 复写原型方法：点击参照三个点的事件
		show = (lazyRefresh = false) => {
			this.focusFlag = false;
	
			let { disabled, isTreelazyLoad, idKey } = this.props,
				{
					selectedValues,
					selectedKeys,
					expandedKeys,
					includeChildren,
					activeKey,
					isExpandLeftArea,
					max,
					isPartJob
				} = this.state;
	
			if (disabled) {
				return false;
			}
	
			this._expandedKeys = expandedKeys;
			!this.hasOwnProperty('prevOverFlow') &amp;&amp; (this.prevOverFlow = document.body.style.overflow);
			document.body.style.overflow = 'hidden';
	
			let { refType, rootNode, pageSize, isMultiSelectedEnabled } = this.props,
				{ tableData } = this.state,
				param;
	
			// 先查常用，常用没有的话再查全部
			(cb => {
				// lazyRefresh：只刷新当前页面
				// lazyRefresh可能是e
				if (lazyRefresh === true) {
					activeKey === '2'
						? cb()
						: this.loadAndSetTableData(
								{
									pageInfo: {
										pageIndex: -1,
										pageSize
									}
								},
								false
							);
				} else {
					this.checkUsual(cb);
				}
			})(() => {
				// 没常用，查全部
				if (refType === 'grid') {
					param = this.__getParam({
						pageInfo: tableData[0].page
					});
					this.loadAndSetTableData(param);
				} else {
					param = this.__getParam({
						pid: isTreelazyLoad ? rootNode.refpk : '',
						pageInfo: {
							pageSize,
							pageIndex: -1
						}
					});
					this.loadTreeData(param).then(data => {
						this.setTreeData('treeData', rootNode, data);
						if (refType === 'gridTree') {
							let { treeDataWithChildren, keyMap } = this.state,
								firstSelectedKeys = selectedKeys[0];
							if (keyMap[firstSelectedKeys]) {
								// 选中的节点是真实存在的
								firstSelectedKeys = keyMap[firstSelectedKeys].refpk;
							} else {
								firstSelectedKeys = '';
							}
							try {
								// 默认第一个节点
								let firstTreeNode = treeDataWithChildren[0].children[0];
								!firstSelectedKeys &amp;&amp; (firstSelectedKeys = firstTreeNode.refpk || firstTreeNode[idKey]);
							} catch (e) {}
							if (firstSelectedKeys) {
								// 查右表
								param = this.__getParam({
									pid: firstSelectedKeys,
									queryCondition: {
										isPartJob: isPartJob || false
									}
								});
								this.loadAndSetTableData(param);
								this.setState({
									selectedKeys: [
										firstSelectedKeys
									]
								});
							} else {
								// 重置左树和右表
								selectedKeys = [];
								tableData[0].rows = [];
								this.setState({
									tableData,
									selectedKeys
								});
							}
						}
					});
				}
				this.setState({
					activeKey: '2'
				});
			});
			if (refType === 'tree' &amp;&amp; !isMultiSelectedEnabled) {
				selectedKeys = [
					...this._value.values()
				]
					.slice(0, 1)
					.map(e => e[idKey]);
			}
			this.runWithChildren = !!this.state.runWithChildren;
			this.setState(
				{
					isShow: true,
					isFirstShow: false,
					dropDownShow: false,
					isSelectedShow: false,
					searchVal: '',
					treeSearchVal: '',
					selectedShow: false,
					max: lazyRefresh === true ? max : false,
					isExpandLeftArea: lazyRefresh === true ? isExpandLeftArea : false,
					selectedKeys,
					isMultiSelectMode: !(
						[
							...selectedValues.keys()
						].length &lt;= 1 &amp;&amp; !includeChildren
					),
					selectedRowIndex: -1
				},
				() => {
					this.referInput &amp;&amp; this.referInput.blur();
					// 防止焦点丢失
					this.popWindow &amp;&amp; !this.popWindow.contains(document.activeElement) &amp;&amp; this.popWindow.focus();
				}
			);
		};

		// 左树的点击事件：左树右表时查右表数据, 树时选中节点
	onTreeNodeSelect = (_selectedKeys, { node }) => {
		// console.log('点击树：', _selectedKeys, { selected, selectedNodes, node, event });
		let keyPressFlag = false;
		if (
			window.event &amp;&amp;
			[
				'keyCode',
				'charCode',
				'which'
			].find(e => window.event[e])
		) {
			keyPressFlag = true;
		}
		let { refType, rootNode, idKey, pageSize } = this.props,
			pid = node.props.treeNodeData[idKey],
			{ searchVal, isExpandLeftArea, isMultiSelectMode, selectedValues, selectedKeys, expandedKeys,isPartJob } = this.state;

		// 单击展开并选中
		!keyPressFlag &amp;&amp;
			(expandedKeys = [
				...new Set([
					...expandedKeys,
					pid
				])
			]);
		selectedKeys = [
			pid
		];

		// 查下级
		!keyPressFlag &amp;&amp; this.loadTreeChildrenDataIfNeeded(node);

		if (refType === 'gridTree') {
			// 左树右表
			if (node.props.treeNodeData[idKey] === rootNode[idKey]) return;
			if (!node.props.disableCheckbox) {
				if (!isExpandLeftArea) {
					// 查右表数据
					this.loadAndSetTableData({
						pid: node.props.treeNodeData.refpk,
						pageInfo: {
							pageIndex: 0,
							pageSize
						},
						keyword: searchVal,
						queryCondition : {
							isPartJob : isPartJob || false
						}
					});
				}
			}
		} else if (refType === 'tree') {
			// 树
			if (!isMultiSelectMode) {
				// 单选模式
				({ selectedValues } = this.treeSelect(node));
				this.setState({
					selectedValues
				});
			}
		}
		this.setState({
			expandedKeys,
			selectedKeys
		});
	};

}
AdjPopRefer = MultiLangWrapper(AdjPopRefer);
export default  AdjPopRefer</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#sortBtns">sortBtns</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 16:34:25 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
