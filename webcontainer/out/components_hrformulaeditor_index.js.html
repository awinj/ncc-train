<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/hrformulaeditor/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/hrformulaeditor/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by wanghongxiang on 2018/10/18.
 */
import React, {Component} from 'react';
import PropTypes from 'prop-types';
import {base, ajax, toast, getMultiLang, inlt} from 'nc-lightapp-front';
import FuncComponent from './components/func'
import FormulaArea from './components/container'
import FormulaBtns from './components/btns'
import FormulaField from './components/fields'
// TODO: 提供扩展的btns, 函数, 数据库表及字段

const {
    NCButton,
    NCRow,
    NCCol,
    NCTabs,
    NCTextArea,
    NCModal,
    NCTree,
    NCCheckbox
} = base;
const {NCTabPane} = NCTabs;
const {Header, Body, Footer} = NCModal;


import './index.less'
import HrRefer from "../hr-refer";
import HrReferLoader from "../hr-refer/ReferLoader";
import HrPanel from '../hrPanels'
import ModalUtil from './utils/index'

const staticURL = {
    common: '/nccloud/formula/web/formulatype.do'
}

const propTypes = {
    formulaData: PropTypes.array,
    formulaUrl: PropTypes.string,
    validateUrl: PropTypes.string,
    defaultFormulaStr: PropTypes.string,
    searchParam: PropTypes.object,
    saveCallback: PropTypes.func,
    referSaveBack: PropTypes.func,
    btnConfig: PropTypes.array
};
const defaultProps = {
    formulaData: [],
    defaultFormulaStr:'',
    formulaUrl: '/nccloud/hrwa/formula/FormulaTypeAction.do',
    validateUrl: '/nccloud/hrwa/formula/TranslateFormulaAction.do',
    saveFormulaUrl: '/nccloud/hrwa/formula/FormulaValidateAction.do',
    searchParam: {},
    saveCallback: () => {
    },
    closeCallback: () =>{

    },
    referSaveBack: () => {
    },
    showRecall: '',
    btnConfig:  null,
    btnClass: ''
};

class HRFormulaEditor extends Component {
    static childContextTypes = {
        ctx: PropTypes.object,
        hrReferChange: PropTypes.func
    }

    constructor(props) {
        super(props)
        this.state = {
            pageConfig: {}, // 存储业务信息
            showModal: false,
            childrenList: [],
            formulaText: '',
            refQuery: {},
            searchParam: this.props.searchParam || {},
            inputSig: '',    // 当前公式
            refcode: '',   //用于参照
            refConfig: {
                isShowUnit: true,
                unitProps: {}
            },   // 参照配置文件
            fieldData: {},   // 当前使用field属性
            comp: '',     // panel 名字
            currentField: null,  // 当前点击字段全部属性
            json: null,
            countryPk: null,
            btnConfig: [],  // 公式按钮
            defined: false,   // 自定义公式
            switchDefined: 0 // 标识是否是自身触发的输入
        }
        this.countryPk = null
        this.originFormula = null
        this.close = this.close.bind(this)
        this.saveForm = this.saveForm.bind(this)
        this.validate = this.validate.bind(this)
        this.hrReferChange = this.hrReferChange.bind(this)
        this.handleState = this.handleState.bind(this)
        this.recallFormula = this.recallFormula.bind(this)
    }

    getChildContext() {
        return {
            ctx: this,
            hrReferChange: this.hrReferChange
        }
    }
    
    componentWillReceiveProps() {
        let callback = (json, status, inlt)=> {
            if (status) {
                this.setState({
                    json: json
                }, () => {
                    this.setState({
                        btnConfig: this.props.btnConfig ? this.props.btnConfig : [
                            {name: this.state.json['hrpub-000049'],value: this.state.json['hrpub-000049'],pos: 'top'},
                            {name: this.state.json['hrpub-000050'],value: this.state.json['hrpub-000050'],pos: 'top'},
                            {name: this.state.json['hrpub-000051'],value: this.state.json['hrpub-000051'],pos: 'top'},
                            {name: this.state.json['hrpub-000052'],value: this.state.json['hrpub-000052'],pos: 'top'},
                            {name: this.state.json['hrpub-000053'],value: this.state.json['hrpub-000053'],pos: 'top'},
                            {name: '+',value: '+',pos: 'bottom'},
                            {name: '-',value: '-',pos: 'bottom'},
                            {name: '*',value: '*',pos: 'bottom'},
                            {name: '/',value: '/',pos: 'bottom'},
                            {name: '&lt;',value: '&lt;',pos: 'bottom'},
                            {name: '>',value: '>',pos: 'bottom'},
                            {name: '=',value: '=',pos: 'bottom'},
                            {name: '(',value: '(',pos: 'bottom'},
                            {name: ')',value: ')',pos: 'bottom'},
                            {name: '&lt;=',value: '&lt;=',pos: 'bottom'},
                            {name: '>=',value: '>=',pos: 'bottom'},
                            {name: '&lt;>',value: '&lt;>',pos: 'bottom'}
                        ]
                    })
                })
                window.ff = this

            }
        }
        getMultiLang({domainName: 'hrpub', moduleId: 'hrpub', callback})
    }

    // 获取公共函数
    getCommon() {
        return new Promise((resolve, reject) => {
            ajax({
                url: staticURL.common,
                data: {},
                success: res => {
                    if (res.success) {
                        resolve(JSON.parse(JSON.stringify(res.data)))
                    } else {
                        reject(res.error &amp;&amp; res.error)
                    }
                }
            })
        })
    }

    // 获取业务公式
    getFormulaRegion() {
        let o = this
        return new Promise((resolve, reject) => {
            if (this.props.formulaUrl) {
                ajax({
                    url: this.props.formulaUrl,
                    data: o.state.searchParam,
                    success: res => {
                        if (res.success) {
                            let data = JSON.parse(res.data)
                            resolve(data)
                        } else {
                            reject(res.error &amp;&amp; res.error)
                        }
                    }
                })
            } else {
                resolve([])
            }
        })
    }

    handleState(obj, callback = () => {
    }) {
        this.setState(obj, () => {
            callback()
        })
    }

    validate() {
        let formulaStr = this.hrFormulaArea.getCurrentFormula()
        ajax({
            url: this.props.saveFormulaUrl,
            data: Object.assign(this.state.searchParam, {
                formulastr: formulaStr,
                condition: this.countryPk
            }),
            success: res => {

                if (res.success) {
                    toast({color: 'success', content: '公式验证通过！'});
                } else {
                    toast({color: 'error', content: '公式验证失败！'});
                }
            }
        })
    }

    show(searchParam = {}, Obj = {}) {
        this.setState({
            inputSig: '',    // 当前公式
            refcode: '',
            showModal: true,
            pageConfig: Obj.pageConfig || {},
            searchParam: searchParam,
            pk_wa_item: Obj.pk_wa_item,
            defaultFlag: Obj.defaultFlag,
            defined: !Obj.defaultFlag,
        }, () => {
            this.getFormulaRegion().then(result => {
                this.setState({
                    childrenList: result
                }, ()=> {
                    this.hrFormulaArea.setCurrentFormula(this.props.defaultFormulaStr || searchParam.defaultFormulaStr)
                })
            })
            // this.recallFormula(false)

        })
    }

    recallFormula(flag = true) {
        if(this.state.searchParam.recallFormula){
            this.hrFormulaArea.setCurrentFormula('')
        }else{
            ajax({
                url: '/nccloud/hrwa/classitem/QueryByItemPkAction.do',
                data: Object.assign({}, this.state.searchParam, {
                    pk_wa_item: this.state.pk_wa_item
                }),
                success: res => {
                    if (res.success &amp;&amp; res.data) {
                        if (this.state.defaultFlag) {
                            this.setState({
                                defined: false
                            })
                        } else {
                            this.setState({
                                defined: true
                            })
                        }
                        this.originFormula = res.data.formulaStr
                        if (flag) {
                            this.hrFormulaArea.setCurrentFormula(res.data.formulaStr)
                        }
                    }
                }
            })
        }

    }

    close() {
        this.setState({
            showModal: false
        })
        this.props.closeCallback()
    }

    saveForm() {
        ajax({
            url: this.props.saveFormulaUrl,
            data: Object.assign(this.state.searchParam, {
                formulastr: this.hrFormulaArea.getCurrentFormula(),
                condition: this.countryPk
            }),
            success: res => {
                if (res.success) {

                    this.props.defaultFormulaStr = this.hrFormulaArea.getCurrentFormula()
                    this.props.saveCallback(res)
                    // toast({color: 'success', content: '保存成功！'})
                    this.close()
                }
            }
        })
    }

    // 公式fields 参照回调
    hrReferChange(val0, val1) {

        let fields = this.state.fieldData
        let display = val0.values&amp;&amp;val0.values['md_enumvalue.name']? val0.values['md_enumvalue.name'].value:val1.display
        this.setState({
            inputSig: `${fields.inputSig} = "${display}"`,
            formulaText: '说明：' + fields.hintMsg
        })
    }

    // 公式左侧 弹出内容回调事件
    panelConfirm(data) {
        let field = this.state.strCode
        //TODO: 接下来的基本操作就是格式输出
        let inputSig = ModalUtil.handleFieldByType(data, field)
        this.setState({
            inputSig: inputSig,
            formulaText: '说明：' + field.hintMsg
        })
    }

    render() {
        var conf = this.state.json ? { multiLang: {  domainName: 'hrpub', currentLocale: 'zh-CN',  moduleId: 'hrpub'},
            refType: 'grid',
            refName: 'hrpub-000004',/* 国际化处理： 证书类型*/
            placeholder: 'hrpub-000004',/* 国际化处理： 证书类型*/
            refCode: 'hrwa.ref.MDEnumRefModel',
            queryGridUrl: '/nccloud/hrwa/ref/MDEnumRefModel.do',
            // columnConfig: [{name: [ 'hrpub-000005', 'hrpub-000006' ],code: [ 'refcode', 'refname' ]}],/* 国际化处理： 编码,名称*/
            columnConfig: [{name: [ this.state.json['hrpub-000005'], this.state.json['hrpub-000006'] ],code: [ 'refcode', 'refname' ]}],/* 国际化处理： 编码,名称*/
            isMultiSelectedEnabled: false
        }: {};
        var config = Object.assign({}, conf, this.state.refQuery)
        let modal = this.state.json ? (
            &lt;React.Fragment>
                &lt;NCModal
                    id="hr-formula"
                    className="hr-formula"
                    show={
                        this.state.showModal
                    }
                    onHide={
                        this.close
                    }
                    size="xlg"
                >
                    &lt;Header className="hr-formula-header" closeButton>
                        &lt;header className="hr-formula-header-name">{this.state.json['hrpub-000041']}{/*公式编辑器*/}&lt;/header>
                    &lt;/Header>
                    &lt;Body className="hr-formula-body">
                    &lt;div>
                        &lt;header className="hr-formula-body-header">
                            {/*自定义公式*/}
                            &lt;div className="hr-formula-body-header-btns">
                                {/*自定义公式*/}
                                &lt;NCCheckbox className="hr-panel-checkbox" disabled={true} checked={this.state.defined}>&lt;/NCCheckbox> {this.state.json['hrpub-000070']}
                                &lt;NCButton onClick={this.validate.bind(this)}>{this.state.json['hrpub-000042']}{/*验证公式*/}&lt;/NCButton>
                                &lt;NCButton style={{display: this.props.showRecall}} onClick = {this.recallFormula.bind(this)}>
                                    {this.state.searchParam.btnName ==='reset'? this.state.json['hrpub-000072']: this.state.json['hrpub-000043']}{/*恢复公式*/}&lt;/NCButton>
                            &lt;/div>
                        &lt;/header>
                        &lt;NCRow className="hr-formula-body-container">
                            &lt;NCCol className="hr-formula-body-container-item" md={2} xs={2} sm={2}>
                                &lt;div className="item-content">
                                    &lt;div className="item-content-header">
                                        &lt;span>{this.state.json['hrpub-000040']}{/*函数*/}&lt;/span>
                                    &lt;/div>
                                    &lt;div>
                                        &lt;FuncComponent/>
                                    &lt;/div>
                                &lt;/div>
                            &lt;/NCCol>
                            &lt;NCCol className="hr-formula-body-container-item" md={6} xs={6} sm={6}>
                                &lt;div className="item-content item-content-area-content">
                                    &lt;div className="item-content-area">
                                        &lt;div className="item-content-header item-content-header-line">&lt;/div>
                                        &lt;FormulaArea ref={hrFormulaArea => this.hrFormulaArea = hrFormulaArea}
                                                     val={this.state.inputSig}>&lt;/FormulaArea>
                                    &lt;/div>
                                    &lt;div className="item-content-btns">
                                        &lt;FormulaBtns btnClass="hr-btn-class"  btnConfig={this.state.btnConfig}>&lt;/FormulaBtns>
                                    &lt;/div>
                                &lt;/div>
                            &lt;/NCCol>
                            &lt;NCCol className="hr-formula-body-container-item" md={4} xs={4} sm={4}>
                                &lt;div className="item-content">
                                    &lt;div>
                                        &lt;div className="item-content-header floatLeft">&lt;span>{this.state.json['hrpub-000044']}{/*数据库表*/}&lt;/span>&lt;/div>
                                        &lt;div className="item-content-header floatLeft">&lt;span>{this.state.json['hrpub-000045']}{/*表字段*/}&lt;/span>&lt;/div>
                                    &lt;/div>
                                    &lt;div>
                                        &lt;FormulaField childrenList={this.state.childrenList&amp;&amp;this.state.childrenList.tableList}>&lt;/FormulaField>
                                    &lt;/div>
                                &lt;/div>
                            &lt;/NCCol>
                        &lt;/NCRow>
                    &lt;/div>
                    &lt;div className="hr-formula-text">
                        {this.state.formulaText}
                    &lt;/div>
                    &lt;/Body>

                    &lt;Footer>
                        &lt;NCButton colors='primary' onClick={this.saveForm}>{this.state.json['hrpub-000046']}{/*保存*/}&lt;/NCButton>
                        &lt;NCButton onClick={this.close}>{this.state.json['hrpub-000047']}{/*取消*/}&lt;/NCButton>
                    &lt;/Footer>
                &lt;/NCModal>
                &lt;div style={{display: 'none'}}>
                    &lt;HrRefer
                        ref="hr-refer"
                        className="hr-refer"
                        {...this.state.refConfig}
                        onChange={this.hrReferChange.bind(this)}
                    >&lt;/HrRefer>
                    &lt;HrReferLoader
                        ref="hr-refer-loader"
                        className="hr-refer-loader"
                        refcode={this.state.refcode}
                    >&lt;/HrReferLoader>
                &lt;/div>
                &lt;HrPanel ref="hr-panel-modal"
                         comp={this.state.comp}
                         panelConfirm={this.panelConfirm.bind(this)}
                         searchParam = {this.state.searchParam}
                         pageConfig = {this.state.pageConfig}
                >&lt;/HrPanel>

                &lt;HrRefer
                    style={{display: 'none'}}
                    ref = "psntype-refer"
                    {...config}
                    onChange={this.hrReferChange.bind(this)}
                >&lt;/HrRefer>
            &lt;/React.Fragment>
        ): null
        return (
            &lt;div>
                {
                    modal
                }
            &lt;/div>
        )
    }
}

HRFormulaEditor.propTypes = propTypes
HRFormulaEditor.defaultProps = defaultProps
export default HRFormulaEditor</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="Maybe.html">Maybe</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#dealHeader">dealHeader</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#fixedCol">fixedCol</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#handleQueryRefer">handleQueryRefer</a></li><li><a href="global.html#handleTableChangeColor">handleTableChangeColor</a></li><li><a href="global.html#snCreateUIDom">snCreateUIDom</a></li><li><a href="global.html#sortBtns">sortBtns</a></li><li><a href="global.html#transRadio">transRadio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 10:52:13 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
