<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/exportHtml.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/exportHtml.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {formatDate} from "./utils";
import {getBusinessInfo, getMultiLang} from 'nc-lightapp-front';

let businessInfo = getBusinessInfo() || {};

let idTmr, id = "export-html-excel", ahtml, lang = {}, hasOpr = false;

export default function exportHtmlFunc(tableDom, config = {}, tableData) {
    getLanguage(() => {
        const tableDomClone = tableDom.cloneNode(true);
        ahtml = document.createElement("a");
        ahtml.setAttribute("href", "#");
        ahtml.setAttribute("id", id);
        ahtml.setAttribute("style", "display:none");
        tableDomClone.append(ahtml);
        let tableTemp;
        if (tableData) {
            tableTemp = getHtmlTempFromData(tableData, config, tableDomClone);
        } else {
            tableTemp = getHtmlTemp(tableDomClone, config);
        }
        method1(tableTemp, config);
        tableDomClone.removeChild(ahtml);
    })
}

function getLanguage(outCallback) {
    let callback = (json, status, inlt) => {
        if (status) {
            lang = json;
            outCallback();
        }
    };
    getMultiLang({domainName: 'hrpub', moduleId: 'hrpub', callback});
}

function getHtmlTempFromData(tableData, config, tableDom) {
    let thStr = '&lt;tr>', tdStr = '', colLen = 0;
    if (tableData.showIndex) {
        colLen++;
        thStr += `&lt;th>${lang['hrpub-000038']}&lt;/th>`;
    }
    tableData.meta.items.forEach(item => {
        if (item.visible &amp;&amp; item.attrcode !== 'opr') {
            colLen++;
            thStr += `&lt;th>${item.label}&lt;/th>`;
        }
        if (item.attrcode === 'opr') {
            hasOpr = true;
        }
    });
    thStr += '&lt;/tr>';
    tableData.data.forEach((itemData, index) => {
        tdStr += '&lt;tr>';
        if (tableData.showIndex) {
            tdStr += `&lt;td>${index + 1}&lt;/td>`
        }
        tableData.meta.items.forEach(item => {
            if (item.visible &amp;&amp; item.attrcode !== 'opr') {
                tdStr += `&lt;td style="${item.itemtype === 'number' ? 'text-align: right' : ''}">${getDisplay(item, itemData)}&lt;/td>`;
            }
        });
        tdStr += '&lt;/tr>';
    });
    let htmlStr = `&lt;table class="excel-table" style="vnd.ms-excel.numberformat:@">&lt;tr>`;
    if (config.title) {
        htmlStr += `&lt;tr>&lt;th class="excel-title" colspan=${colLen}>${config.title}&lt;/th>&lt;/tr>&lt;tr>&lt;/tr>`;
    }
    let tabFooter = tableDom.querySelector('.u-table-scroll .u-table-footer .u-table-tbody'), tabFooterStr = '';
    if (tabFooter) {
        if (hasOpr) {
            tabFooter.querySelector('tr').removeChild(tabFooter.querySelector('tr').lastElementChild);
        }
        tabFooterStr = tabFooter.innerHTML;
    }
    let footerStr = `&lt;tr>&lt;/tr>&lt;tr class="excel-footer">&lt;td>${lang['hrpub-000036']}:&lt;/td>&lt;td>${businessInfo.userName || ''}&lt;/td>`;
    /* 国际化处理： 制单人*/
    let nums = colLen - 4, emptyTd = '';
    if (nums > 0) emptyTd = '&lt;td>&lt;/td>'.repeat(nums);
    footerStr += emptyTd + `&lt;td>${lang['hrpub-000037']}:&lt;/td>&lt;td>${getToday()}&lt;/td>`;
    /* 国际化处理： 制表日期*/
    //如果有参数为html,添加到最终的html中
    let html = config.html ? `&lt;tr class="form">${config.html}&lt;/tr>&lt;tr>&lt;/tr>&lt;tr>&lt;/tr>` : ``;
    return htmlStr + html + thStr + tdStr + tabFooterStr + footerStr + '&lt;/tr>&lt;/table>';
}

function getDisplay(item, value) {
    if (!value.values[item.attrcode]) return '';
    let displayStr = value.values[item.attrcode].display, displayValue = value.values[item.attrcode].value;
    if (!displayStr &amp;&amp; item.options) {
        const option = item.options.filter(option => option.value === displayValue);
        if (option) {
            displayStr = option.display;
        }
    }
    return displayStr || displayValue || '';
}

function getHtmlTemp(tableDom, config) {
    const headDom = tableDom.querySelector('.u-table-scroll .u-table-thead');
    const th = headDom.children[0]
    //处理表头
    removeOpr(th)
    const colLen = headDom.querySelectorAll('th').length;
    let thStr = headDom.innerHTML.replace(/width="\d*(\.\d+)?"|style="[^"]*"/g, '');
    let tr = tableDom.querySelector('.u-table-scroll .u-table-tbody').children
    //处理表体
    for (let i = 0; i &lt; tr.length; i++) {
        removeOpr(tr[i])
    }
    let tdStr = tableDom.querySelector('.u-table-scroll .u-table-tbody').innerHTML;
    let htmlStr = `&lt;table class="excel-table" style="vnd.ms-excel.numberformat:@">&lt;tr>`;
    if (config.title) {
        htmlStr += `&lt;tr>&lt;th class="excel-title" colspan=${colLen}>${config.title}&lt;/th>&lt;/tr>&lt;tr>&lt;/tr>`;
    }
    let tabFooter = tableDom.querySelector('.u-table-scroll .u-table-footer .u-table-tbody'), tabFooterStr = '';
    if (tabFooter) {
        tabFooterStr = tabFooter.innerHTML;
    }
    let footerStr = `&lt;tr>&lt;/tr>&lt;tr class="excel-footer">&lt;td>${config.maker}:&lt;/td>&lt;td>${businessInfo.userName || ''}&lt;/td>`;
    /* 国际化处理： 制单人*/
    let nums = colLen - 4, emptyTd = '';
    if (nums > 0) emptyTd = '&lt;td>&lt;/td>'.repeat(nums);
    footerStr += emptyTd + `&lt;td>${config.date}:&lt;/td>&lt;td>${getToday()}&lt;/td>`;
    /* 国际化处理： 制表日期*/
    //如果有参数为html,添加到最终的html中
    let html = config.html ? `&lt;tr class="form">${config.html}&lt;/tr>&lt;tr>&lt;/tr>&lt;tr>&lt;/tr>` : ``
    return htmlStr + html + thStr + tdStr + tabFooterStr + footerStr + '&lt;/tr>&lt;/table>';
}

//去除自定义列
function removeOpr(dom) {
    if (dom.lastElementChild.innerHTML.includes('opr')) {
        dom.lastElementChild.remove()
        removeOpr(dom)
    }
}

function getToday() {
    return formatDate(new Date())
}

function getExplorer() {
    let explorer = window.navigator.userAgent;
    //ie
    if ('ActiveXObject' in window) {
        return 'ie';
    }
    //firefox
    else if (explorer.indexOf("Firefox") >= 0) {
        return 'Firefox';
    }
    //Chrome
    else if (explorer.indexOf("Chrome") >= 0) {
        return 'Chrome';
    }
    //Opera
    else if (explorer.indexOf("Opera") >= 0) {
        return 'Opera';
    }
    //Safari
    else if (explorer.indexOf("Safari") >= 0) {
        return 'Safari';
    }
}

function method1(curTbl, config) {//整个表格拷贝到EXCEL中
    if (getExplorer() === 'ie') {
        let oXL = new ActiveXObject("Excel.Application");

        //创建AX对象excel
        let oWB = oXL.Workbooks.Add();
        //获取workbook对象
        let xlsheet = oWB.Worksheets(1);
        //激活当前sheet
        let sel = document.body.createTextRange();
        sel.moveToElementText(curTbl);
        //把表格中的内容移到TextRange中
        sel.select;
        //全选TextRange中内容
        sel.execCommand("Copy");
        //复制TextRange中内容
        xlsheet.Paste();
        //粘贴到活动的EXCEL中
        xlsheet.ActiveSheet.Cells(row, col).Borders.Weight = 1;
        oXL.Visible = true;
        //设置excel可见属性
        let fname = '';
        try {
            fname = oXL.Application.GetSaveAsFilename("Excel.xls", "Excel Spreadsheets (*.xls), *.xls");
        } catch (e) {
            print("Nested catch caught " + e);
        } finally {
            oWB.SaveAs(fname);

            oWB.Close();
            //xls.visible = false;
            oXL.Quit();
            oXL = null;
            //结束excel进程，退出完成
            //window.setInterval("Cleanup();",1);
            idTmr = window.setInterval("Cleanup();", 1);
        }
    } else {
        tableToExcel(curTbl, config)
    }
}

function Cleanup() {
    window.clearInterval(idTmr);
    CollectGarbage();
}

/*
    template ： 定义文档的类型，相当于html页面中顶部的&lt;!DOCTYPE> 声明。（个人理解，不确定）
    encodeURIComponent:解码
    unescape() 函数：对通过 escape() 编码的字符串进行解码。
    window.btoa(window.encodeURIComponent(str)):支持汉字进行解码。
    \w ：匹配包括下划线的任何单词字符。等价于’[A-Za-z0-9_]’
    replace()方法：用于在字符串中用一些字符替换另一些字符，或替换一个与正则表达式匹配的子串。
    {(\w+)}：匹配所有 {1个或更多字符} 形式的字符串；此处匹配输出内容是 “worksheet”
    正则中的() ：是为了提取匹配的字符串。表达式中有几个()就有几个相应的匹配字符串。
    讲解(/{(\w+)}/g, function(m, p) { return c[p]; } ：
        /{(\w+)}/g 匹配出所有形式为“{worksheet}”的字符串；
        function参数：  m  正则所匹配到的内容，即“worksheet”；
                        p  正则表达式中分组的内容,即“(\w+)”分组中匹配到的内容，为“worksheet”；
        c ：为object，见下图3
        c[p] : 为“worksheet”

*/
const tableToExcel = (function () {
    let uri = 'data:application/vnd.ms-excel;base64,',
        template = getTemplate(),
        base64 = function (s) {
            return window.btoa(unescape(encodeURIComponent(s)))
        },
        // 下面这段函数作用是：将template中的变量替换为页面内容ctx获取到的值
        format = function (s, c) {
            return s.replace(/{(\w+)}/g,
                function (m, p) {
                    return c[p];
                }
            )
        };
    return function (curTbl, config) {
        // 获取表单的名字和表单查询的内容
        let ctx = {worksheet: config.worksheetName || 'Worksheet', content: curTbl};
        // format()函数：通过格式操作使任意类型的数据转换成一个字符串
        // base64()：进行编码
        /*document.getElementById(id).href = uri + base64(format(template, ctx));
        if (config.fileName) document.getElementById(id).download = config.fileName + ".xls";//自定义文件名
        document.getElementById(id).click();*/
        let dataUrl = uri + base64(format(template, ctx));
        let url = window.URL.createObjectURL(dataURLtoBlob(dataUrl));
        ahtml.href = url;
        if (config.fileName) ahtml.download = config.fileName + ".xls";
        ahtml.click();
        window.URL.revokeObjectURL(url);
    }
})();

function dataURLtoBlob(dataurl) {
    let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type: mime});
}

function getTemplate() {
    return `&lt;html xmlns:o="urn:schemas-microsoft-com:office:office" 
xmlns:x="urn:schemas-microsoft-com:office:excel" 
xmlns="http://www.w3.org/TR/REC-html40">&lt;head>
&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
&lt;!--[if gte mso 9]>
&lt;xml>
        &lt;x:ExcelWorkbook>
            &lt;x:ExcelWorksheets>
                &lt;x:ExcelWorksheet>
                    &lt;x:Name>{worksheet}&lt;/x:Name>
                    &lt;x:WorksheetOptions>
                        &lt;x:DisplayGridlines/>
                    &lt;/x:WorksheetOptions>
                &lt;/x:ExcelWorksheet>
            &lt;/x:ExcelWorksheets>
        &lt;/x:ExcelWorkbook>
    &lt;/xml>
&lt;![endif]-->
&lt;style type="text/css">
   .excel-table th,
   .excel-table td{
        border:  0.5pt solid #000;
    }
    .excel-table .form td {
        border: none;
    }
   .excel-table .excel-title,
   .excel-table .excel-footer td{
        border:  none;
   }
&lt;/style>
&lt;/head>&lt;body>{content}&lt;/body>&lt;/html>`
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="Maybe.html">Maybe</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#dealHeader">dealHeader</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#fixedCol">fixedCol</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#handleQueryRefer">handleQueryRefer</a></li><li><a href="global.html#handleTableChangeColor">handleTableChangeColor</a></li><li><a href="global.html#snCreateUIDom">snCreateUIDom</a></li><li><a href="global.html#sortBtns">sortBtns</a></li><li><a href="global.html#transRadio">transRadio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 10:52:14 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
