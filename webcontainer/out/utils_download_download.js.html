<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/download/download.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/download/download.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/*
*
* created by ling yun on 2018/10/19
*
* 功能: 同域下载方法
* 原理: 通过form表单提交到一个iframe里，通过iframe的onload判断下载结果
* 参数:
*   url: 下载连接
*   body: 下载参数
*   onResult: 当iframe加载完毕时，返回iframe内的body对象，内容可能为空，自行判断内容是否是下载成功还是失败
*   onError: 当跨域，获取不到body的时候，会触发该函数
*   method: form表单提交的方式，默认是post
*   enctype: form表单的enctype 1 2 3 三个值，看代码便知
*
* */

let app = '', appcode = '';
let appN = window.parent.location.hash.split("?");
if (appN &amp;&amp; appN[1]) {
    let appPrams = appN[1].split('&amp;');
    if (appPrams &amp;&amp; appPrams instanceof Array) {
        appPrams.forEach((item) => {
            if (item.indexOf('=') != -1 &amp;&amp; item.split('=') &amp;&amp; item.split('=') instanceof Array) {
                if (item.split('=')[0] === 'n') {
                    if (item.split('=')[1]) {
                        app = decodeURIComponent(decodeURIComponent(item.split('=')[1]));
                    }
                }
                if (item.split('=')[0] === 'c') {
                    if (item.split('=')[1]) {
                        appcode = decodeURIComponent(decodeURIComponent(item.split('=')[1]));
                    }
                }
            }
        });
    }
}

let busiaction = `${app || null}-${window.actionName || null}`;
const sysParamJson = {
    sys_busiaction: busiaction,
    sys_appcode: appcode,
    sys_ts: new Date().getTime()
};


export default function downLoad({url, body, onResult, onError, method = 'post', enctype}) {
    
    const frameName = 'downLoadFrame';
    
    let oForm = document.createElement('form');
    let oIframe = document.createElement('iframe');
    
    let queryOpt = Object.assign({}, body, sysParamJson);
    
    method = method.toUpperCase();
    
    enctype = ((type) => {
        switch (type) {
            case 1:
                return 'multipart/form-data';
            case 2:
                return 'application/x-www-form-urlencoded';
            case 3:
                return 'text/plain';
            default:
                return 'multipart/form-data';
        }
    })(enctype);
    
    oForm.action = url;
    oForm.method = method;
    oForm.target = frameName;
    oForm.enctype = enctype;
    oForm.style.display = 'none';
    
    oIframe.name = frameName;
    oIframe.height = '0';
    oIframe.width = '0';
    oIframe.style.display = 'none';
    
    Object.keys(queryOpt).map((key) => {
        if (queryOpt[key] instanceof Array) {
            queryOpt[key].forEach((item) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = item;
                oForm.appendChild(input);
            })
        } else {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = queryOpt[key];
            oForm.appendChild(input);
        }
    });
    setTimeout(()=>{
        oIframe.onload = function(e) {
            try {
                let body = oIframe.contentWindow.document.body;

                if(body) {
                    onResult &amp;&amp; onResult.call(this, body)
                }
                else {
                    throw new Error();
                }
            }
            catch(e) {
                onError &amp;&amp; onError.call(this, e);
            }

            document.body.removeChild(oForm);
            document.body.removeChild(oIframe);
            oForm = null;
            oIframe = null;
        };
    },0)


    document.body.appendChild(oIframe);
    document.body.appendChild(oForm);
    oForm.submit();
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Header.html">Header</a></li><li><a href="Maybe.html">Maybe</a></li><li><a href="orgRefer.html">orgRefer</a></li><li><a href="Pagination.html">Pagination</a></li></ul><h3>Global</h3><ul><li><a href="global.html#allCheckTable">allCheckTable</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#dealHeader">dealHeader</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#fixedCol">fixedCol</a></li><li><a href="global.html#formatSelectData">formatSelectData</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#handleQueryRefer">handleQueryRefer</a></li><li><a href="global.html#handleTableChangeColor">handleTableChangeColor</a></li><li><a href="global.html#snCreateUIDom">snCreateUIDom</a></li><li><a href="global.html#sortBtns">sortBtns</a></li><li><a href="global.html#transRadio">transRadio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 21 2019 10:52:14 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
